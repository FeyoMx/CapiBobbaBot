{
  "name": "AnÃ¡lisis de Sentimientos - Encuestas CapiBobba",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "cronExpression": "*/15 9-22 * * *"
            }
          ]
        },
        "timezone": "America/Mexico_City"
      },
      "id": "schedule-trigger-survey-001",
      "name": "â° Every 15 Minutes (9am-10pm)",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [240, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://capibobbabot.onrender.com/api/survey/results",
        "authentication": "none",
        "options": {
          "timeout": 10000,
          "response": {
            "response": {
              "fullResponse": false
            }
          }
        }
      },
      "id": "read-survey-results-001",
      "name": "ğŸ“Š Read Survey Results from API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [460, 300],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000
    },
    {
      "parameters": {
        "mode": "runOnceForAllItems",
        "jsCode": "// Filter survey responses that have comments but no sentiment analysis yet\nconst apiResponse = $input.first().json;\n\n// Validar estructura de respuesta\nif (!apiResponse.success || !apiResponse.data) {\n  console.log('âŒ API response invalid or empty');\n  return [];\n}\n\nconst recentSurveys = apiResponse.data.recentSurveys || [];\nconsole.log(`ğŸ“Š Total surveys received: ${recentSurveys.length}`);\n\n// Filtrar encuestas con comentarios sin procesar\nconst unprocessedComments = recentSurveys.filter(survey => {\n  // Must have a comment\n  if (!survey.comment || survey.comment.trim() === '') return false;\n  \n  // Must NOT have sentiment already analyzed\n  if (survey.sentiment) return false;\n  \n  // Must have a valid rating (1-5)\n  if (!survey.rating || survey.rating < 1 || survey.rating > 5) return false;\n  \n  return true;\n});\n\nconsole.log(`ğŸ’¬ Surveys with comments: ${recentSurveys.filter(s => s.comment).length}`);\nconsole.log(`ğŸ”„ Comments to process: ${unprocessedComments.length}`);\n\n// Limit to 20 per execution to avoid overwhelming Gemini API\nconst toProcess = unprocessedComments.slice(0, 20);\n\nif (toProcess.length === 0) {\n  console.log('âœ… No new comments to process');\n  return [];\n}\n\nreturn toProcess.map(survey => ({ json: survey }));"
      },
      "id": "filter-comments-001",
      "name": "ğŸ” Filter Unprocessed Comments",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
        "batchSize": 10,
        "options": {
          "reset": false
        }
      },
      "id": "split-batches-survey-001",
      "name": "ğŸ“¦ Split into Batches of 10",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [900, 300]
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {
          "reset": false
        }
      },
      "id": "loop-comments-001",
      "name": "ğŸ”„ Loop Over Comments",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key={{ $env.GEMINI_API_KEY }}",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  contents: [{\n    parts: [{\n      text: `Analiza el siguiente comentario de una encuesta de satisfacciÃ³n de CapiBobba (bubble tea + capigofres).\n\nRATING: ${$json.rating}/5 estrellas\nCOMENTARIO: \"${$json.comment}\"\n\nGenera un anÃ¡lisis JSON detallado (SOLO el JSON, sin markdown):\n\n{\n  \"sentiment\": \"positive|neutral|negative|very_negative\",\n  \"sentiment_score\": 0.0-1.0,\n  \"topics\": [\"product_quality\", \"delivery_time\", \"customer_service\", \"price\", \"presentation\", \"taste\", \"temperature\"],\n  \"key_phrases\": [\"frase relevante del comentario\"],\n  \"urgency\": \"low|medium|high|critical\",\n  \"actionable\": true|false,\n  \"action_type\": \"response_needed|investigation|improvement|none\",\n  \"summary_es\": \"Resumen en espaÃ±ol (1-2 lÃ­neas)\",\n  \"customer_intent\": \"complaint|suggestion|praise|question\",\n  \"nps_alignment\": \"detractor|passive|promoter\"\n}\n\nCONTEXTO:\n- Rating 1-2: TÃ­picamente negativo (detractores)\n- Rating 3: Neutral (pasivos)\n- Rating 4-5: Positivo (promotores)\n- CapiBobba vende: bubble tea, waffles de capibara, postres\n\nREGLAS:\n- Si rating â‰¤2 pero comentario es positivo â†’ sentiment=negative, urgency=high (sarcasmo o problema)\n- Si rating â‰¥4 pero comentario es negativo â†’ urgency=high (expectativas no cumplidas)\n- topics: mÃ¡ximo 3 temas mÃ¡s relevantes\n- key_phrases: extraer frases textuales (max 3)\n- urgency: critical si rating=1 O palabras como \"pÃ©simo\", \"nunca mÃ¡s\", \"horrible\"\n- nps_alignment debe coincidir con el rating (1-2=detractor, 3=passive, 4-5=promoter)`\n    }]\n  }],\n  generationConfig: {\n    temperature: 0.3,\n    topK: 1,\n    topP: 0.95,\n    maxOutputTokens: 500,\n    responseMimeType: 'application/json'\n  }\n}) }}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "gemini-sentiment-001",
      "name": "ğŸ¤– Analyze Sentiment with Gemini",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1340, 300],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 3000,
      "continueOnFail": true,
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "mode": "runOnceForAllItems",
        "jsCode": "// Extract sentiment analysis from Gemini API response\nconst items = $input.all();\nconst results = [];\n\nfor (const item of items) {\n  try {\n    const response = item.json;\n    \n    // Get original survey data from Loop Over Comments\n    const originalData = $node[\"ğŸ”„ Loop Over Comments\"].json;\n    \n    let analysis = null;\n    let parseError = null;\n    \n    // Try to extract JSON from response\n    if (response?.candidates && response.candidates.length > 0) {\n      const candidate = response.candidates[0];\n      \n      if (candidate?.content?.parts && candidate.content.parts.length > 0) {\n        const text = candidate.content.parts[0].text || '';\n        \n        try {\n          // Parse JSON response\n          analysis = JSON.parse(text);\n          console.log(`âœ… Successfully parsed sentiment for ${originalData.from}`);\n        } catch (jsonError) {\n          console.error(`âŒ Failed to parse JSON: ${jsonError.message}`);\n          console.error(`Raw text: ${text}`);\n          parseError = jsonError.message;\n        }\n      }\n    }\n    \n    // Validate analysis structure\n    if (analysis && typeof analysis === 'object') {\n      // Ensure required fields exist\n      const validatedAnalysis = {\n        sentiment: analysis.sentiment || 'unknown',\n        sentiment_score: parseFloat(analysis.sentiment_score) || 0.5,\n        topics: Array.isArray(analysis.topics) ? analysis.topics.slice(0, 3) : [],\n        key_phrases: Array.isArray(analysis.key_phrases) ? analysis.key_phrases.slice(0, 3) : [],\n        urgency: analysis.urgency || 'low',\n        actionable: Boolean(analysis.actionable),\n        action_type: analysis.action_type || 'none',\n        summary_es: analysis.summary_es || 'Sin resumen',\n        customer_intent: analysis.customer_intent || 'unknown',\n        nps_alignment: analysis.nps_alignment || 'passive'\n      };\n      \n      results.push({\n        json: {\n          ...originalData,\n          sentiment_analysis: validatedAnalysis,\n          processed_at: new Date().toISOString(),\n          processing_status: 'success'\n        }\n      });\n    } else {\n      // Failed to get valid analysis\n      console.error(`âŒ Invalid analysis structure for ${originalData.from}`);\n      \n      results.push({\n        json: {\n          ...originalData,\n          sentiment_analysis: {\n            sentiment: 'error',\n            sentiment_score: 0,\n            topics: [],\n            key_phrases: [],\n            urgency: 'low',\n            actionable: false,\n            action_type: 'none',\n            summary_es: 'Error al procesar',\n            customer_intent: 'unknown',\n            nps_alignment: 'passive'\n          },\n          processed_at: new Date().toISOString(),\n          processing_status: 'error',\n          error_message: parseError || 'Invalid response structure'\n        }\n      });\n    }\n    \n  } catch (error) {\n    console.error('âŒ Error processing item:', error);\n    \n    const originalData = $node[\"ğŸ”„ Loop Over Comments\"].json;\n    \n    results.push({\n      json: {\n        ...originalData,\n        sentiment_analysis: null,\n        processed_at: new Date().toISOString(),\n        processing_status: 'fatal_error',\n        error_message: error.message\n      }\n    });\n  }\n}\n\nreturn results;"
      },
      "id": "parse-sentiment-001",
      "name": "ğŸ§  Extract Sentiment Analysis",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1560, 300]
    },
    {
      "parameters": {
        "resume": "timeInterval",
        "amount": 1000,
        "unit": "milliseconds"
      },
      "id": "wait-delay-sentiment-001",
      "name": "â±ï¸ Wait 1s (Rate Limit)",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [1780, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://capibobbabot.onrender.com/api/survey/update-sentiment",
        "authentication": "none",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  from: $json.from,\n  timestamp: $json.timestamp,\n  rating: $json.rating,\n  comment: $json.comment,\n  sentiment: $json.sentiment_analysis?.sentiment || 'unknown',\n  sentiment_score: $json.sentiment_analysis?.sentiment_score || 0,\n  topics: $json.sentiment_analysis?.topics || [],\n  key_phrases: $json.sentiment_analysis?.key_phrases || [],\n  urgency: $json.sentiment_analysis?.urgency || 'low',\n  actionable: $json.sentiment_analysis?.actionable || false,\n  action_type: $json.sentiment_analysis?.action_type || 'none',\n  summary_es: $json.sentiment_analysis?.summary_es || '',\n  customer_intent: $json.sentiment_analysis?.customer_intent || 'unknown',\n  nps_alignment: $json.sentiment_analysis?.nps_alignment || 'passive',\n  processed_at: $json.processed_at\n}) }}",
        "options": {
          "timeout": 10000
        }
      },
      "id": "update-sentiment-001",
      "name": "ğŸ’¾ Update Survey with Sentiment",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2000, 300],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000,
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "append",
        "sheetName": "SURVEY_SENTIMENT_ANALYSIS",
        "documentId": "={{ $env.GOOGLE_SHEET_MESSAGES || '1XGPUuCRzf2bEOm4UOPmjhnqUuNCsFyaL6Ycbqof_JuI' }}",
        "dataLocationOnSheet": "headerRow",
        "keyRow": 1,
        "dataStartRow": 2,
        "options": {},
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldName": "Timestamp",
              "fieldValue": "={{ $json.timestamp }}"
            },
            {
              "fieldName": "Phone",
              "fieldValue": "={{ $json.from }}"
            },
            {
              "fieldName": "Rating",
              "fieldValue": "={{ $json.rating }}"
            },
            {
              "fieldName": "Comment",
              "fieldValue": "={{ $json.comment }}"
            },
            {
              "fieldName": "Sentiment",
              "fieldValue": "={{ $json.sentiment_analysis?.sentiment || 'unknown' }}"
            },
            {
              "fieldName": "Sentiment_Score",
              "fieldValue": "={{ $json.sentiment_analysis?.sentiment_score || 0 }}"
            },
            {
              "fieldName": "Topics",
              "fieldValue": "={{ ($json.sentiment_analysis?.topics || []).join(', ') }}"
            },
            {
              "fieldName": "Key_Phrases",
              "fieldValue": "={{ ($json.sentiment_analysis?.key_phrases || []).join(' | ') }}"
            },
            {
              "fieldName": "Urgency",
              "fieldValue": "={{ $json.sentiment_analysis?.urgency || 'low' }}"
            },
            {
              "fieldName": "Actionable",
              "fieldValue": "={{ $json.sentiment_analysis?.actionable ? 'YES' : 'NO' }}"
            },
            {
              "fieldName": "Action_Type",
              "fieldValue": "={{ $json.sentiment_analysis?.action_type || 'none' }}"
            },
            {
              "fieldName": "Summary",
              "fieldValue": "={{ $json.sentiment_analysis?.summary_es || '' }}"
            },
            {
              "fieldName": "Customer_Intent",
              "fieldValue": "={{ $json.sentiment_analysis?.customer_intent || 'unknown' }}"
            },
            {
              "fieldName": "NPS_Alignment",
              "fieldValue": "={{ $json.sentiment_analysis?.nps_alignment || 'passive' }}"
            },
            {
              "fieldName": "Processed_At",
              "fieldValue": "={{ $json.processed_at }}"
            },
            {
              "fieldName": "Processing_Status",
              "fieldValue": "={{ $json.processing_status || 'success' }}"
            }
          ]
        }
      },
      "id": "save-to-sheets-001",
      "name": "ğŸ“Š Save to Google Sheets",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [2220, 300],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "google-sheets-oauth",
          "name": "Google Sheets OAuth2"
        }
      },
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.sentiment_analysis?.sentiment }}",
              "operation": "equals",
              "value2": "negative"
            },
            {
              "value1": "={{ $json.sentiment_analysis?.sentiment }}",
              "operation": "equals",
              "value2": "very_negative"
            },
            {
              "value1": "={{ $json.sentiment_analysis?.urgency }}",
              "operation": "equals",
              "value2": "high"
            },
            {
              "value1": "={{ $json.sentiment_analysis?.urgency }}",
              "operation": "equals",
              "value2": "critical"
            }
          ],
          "combinator": "or"
        }
      },
      "id": "check-negative-survey-001",
      "name": "ğŸ˜Ÿ Is Negative or High Urgency?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2440, 300]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Format enhanced Telegram alert for survey comments\nconst data = $input.item.json;\nconst analysis = data.sentiment_analysis || {};\n\n// Enhanced emojis based on urgency\nconst urgencyEmojis = {\n  'critical': 'ğŸš¨',\n  'high': 'âš ï¸',\n  'medium': 'âš¡',\n  'low': 'ğŸ’¬'\n};\n\nconst sentimentEmojis = {\n  'very_negative': 'ğŸ˜¡',\n  'negative': 'ğŸ˜Ÿ',\n  'neutral': 'ğŸ˜',\n  'positive': 'ğŸ˜Š'\n};\n\nconst emoji = sentimentEmojis[analysis.sentiment] || 'ğŸ“Š';\nconst urgencyEmoji = urgencyEmojis[analysis.urgency] || '';\n\n// NPS indicator\nconst npsEmoji = {\n  'detractor': 'ğŸ”´',\n  'passive': 'ğŸŸ¡',\n  'promoter': 'ğŸŸ¢'\n}[analysis.nps_alignment] || '';\n\n// Format timestamp\nconst timestamp = new Date(data.commentTimestamp || data.timestamp).toLocaleString('es-MX', {\n  timeZone: 'America/Mexico_City',\n  dateStyle: 'short',\n  timeStyle: 'short'\n});\n\n// Truncate comment if too long\nconst maxLength = 200;\nlet commentText = data.comment || 'Sin comentario';\nif (commentText.length > maxLength) {\n  commentText = commentText.substring(0, maxLength) + '...';\n}\n\n// Build enhanced Telegram message\nconst message = `${urgencyEmoji}${emoji}${npsEmoji} <b>ENCUESTA - ${(analysis.sentiment || 'UNKNOWN').toUpperCase()}</b>\n\nğŸ‘¤ <b>Cliente:</b> <code>${data.from}</code>\nâ­ <b>Rating:</b> ${data.rating}/5\nğŸ“Š <b>NPS:</b> ${analysis.nps_alignment || 'unknown'}\nâ° <b>Fecha:</b> ${timestamp}\n\nğŸ’¬ <b>Comentario:</b>\n<i>\"${commentText}\"</i>\n\nğŸ¤– <b>AnÃ¡lisis IA:</b>\nâ€¢ <b>Sentimiento:</b> ${analysis.sentiment} (${((analysis.sentiment_score || 0) * 100).toFixed(0)}%)\nâ€¢ <b>IntenciÃ³n:</b> ${analysis.customer_intent || 'unknown'}\nâ€¢ <b>Temas:</b> ${(analysis.topics || []).join(', ')}\nâ€¢ <b>Urgencia:</b> ${analysis.urgency}\nâ€¢ <b>AcciÃ³n:</b> ${analysis.action_type || 'none'}\n\nğŸ“ <b>Resumen:</b>\n${analysis.summary_es || 'Sin resumen'}\n\n${analysis.key_phrases && analysis.key_phrases.length > 0 ? `\\nğŸ”‘ <b>Frases clave:</b>\\n${analysis.key_phrases.map(p => `  â€¢ \"${p}\"`).join('\\n')}` : ''}\n\n${analysis.actionable ? '\\nâš ï¸ <b>Este comentario requiere atenciÃ³n inmediata</b>' : ''}\n\nğŸ“Š <a href=\"https://docs.google.com/spreadsheets/d/1XGPUuCRzf2bEOm4UOPmjhnqUuNCsFyaL6Ycbqof_JuI/edit\">Ver anÃ¡lisis completo</a>`;\n\nreturn [{\n  json: {\n    message,\n    chatId: $env.TELEGRAM_CHAT_ID || '27606954',\n    parseMode: 'HTML'\n  }\n}];"
      },
      "id": "format-alert-survey-001",
      "name": "ğŸ“± Format Telegram Alert",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2660, 200]
    },
    {
      "parameters": {
        "resource": "message",
        "operation": "sendMessage",
        "chatId": "={{ $json.chatId }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parseMode": "HTML",
          "disableWebPagePreview": false,
          "disableNotification": false
        }
      },
      "id": "telegram-alert-survey-001",
      "name": "ğŸ“¢ Send Telegram Alert",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [2880, 200],
      "credentials": {
        "telegramApi": {
          "id": "telegram-bot",
          "name": "Telegram Bot API"
        }
      },
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 1500,
      "continueOnFail": true
    },
    {
      "parameters": {
        "mode": "runOnceForAllItems",
        "jsCode": "// Calculate sentiment statistics for this batch\nconst items = $input.all();\n\n// Initialize counters\nconst stats = {\n  total: items.length,\n  positive: 0,\n  neutral: 0,\n  negative: 0,\n  very_negative: 0,\n  errors: 0,\n  actionable: 0,\n  high_urgency: 0,\n  critical_urgency: 0\n};\n\n// Count sentiments and urgencies\nfor (const item of items) {\n  const analysis = item.json.sentiment_analysis || {};\n  const sentiment = analysis.sentiment;\n  \n  switch (sentiment) {\n    case 'positive':\n      stats.positive++;\n      break;\n    case 'neutral':\n      stats.neutral++;\n      break;\n    case 'negative':\n      stats.negative++;\n      break;\n    case 'very_negative':\n      stats.very_negative++;\n      break;\n    case 'error':\n    case 'unknown':\n      stats.errors++;\n      break;\n  }\n  \n  // Count actionable items\n  if (analysis.actionable) {\n    stats.actionable++;\n  }\n  \n  // Count urgency levels\n  if (analysis.urgency === 'high') {\n    stats.high_urgency++;\n  } else if (analysis.urgency === 'critical') {\n    stats.critical_urgency++;\n  }\n}\n\n// Calculate percentages\nstats.positive_pct = ((stats.positive / stats.total) * 100).toFixed(1);\nstats.negative_pct = (((stats.negative + stats.very_negative) / stats.total) * 100).toFixed(1);\nstats.actionable_pct = ((stats.actionable / stats.total) * 100).toFixed(1);\n\n// Add timestamp\nstats.fecha_ejecucion = new Date().toISOString();\nstats.fecha_formato = new Date().toLocaleString('es-MX', {\n  timeZone: 'America/Mexico_City',\n  dateStyle: 'medium',\n  timeStyle: 'short'\n});\n\nconsole.log('ğŸ“Š Sentiment Analysis Statistics:', stats);\n\nreturn [{ json: stats }];"
      },
      "id": "calculate-stats-survey-001",
      "name": "ğŸ“Š Calculate Statistics",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2440, 500]
    },
    {
      "parameters": {
        "operation": "append",
        "sheetName": "SENTIMENT_STATS",
        "documentId": "={{ $env.GOOGLE_SHEET_MESSAGES || '1XGPUuCRzf2bEOm4UOPmjhnqUuNCsFyaL6Ycbqof_JuI' }}",
        "dataLocationOnSheet": "headerRow",
        "keyRow": 1,
        "dataStartRow": 2,
        "options": {},
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldName": "Fecha",
              "fieldValue": "={{ $json.fecha_formato }}"
            },
            {
              "fieldName": "Total_Analizados",
              "fieldValue": "={{ $json.total }}"
            },
            {
              "fieldName": "Positivos",
              "fieldValue": "={{ $json.positive }}"
            },
            {
              "fieldName": "Neutrales",
              "fieldValue": "={{ $json.neutral }}"
            },
            {
              "fieldName": "Negativos",
              "fieldValue": "={{ $json.negative }}"
            },
            {
              "fieldName": "Muy_Negativos",
              "fieldValue": "={{ $json.very_negative }}"
            },
            {
              "fieldName": "Errores",
              "fieldValue": "={{ $json.errors }}"
            },
            {
              "fieldName": "Accionables",
              "fieldValue": "={{ $json.actionable }}"
            },
            {
              "fieldName": "Urgencia_Alta",
              "fieldValue": "={{ $json.high_urgency }}"
            },
            {
              "fieldName": "Urgencia_Critica",
              "fieldValue": "={{ $json.critical_urgency }}"
            },
            {
              "fieldName": "Positivos_Pct",
              "fieldValue": "={{ $json.positive_pct }}"
            },
            {
              "fieldName": "Negativos_Pct",
              "fieldValue": "={{ $json.negative_pct }}"
            },
            {
              "fieldName": "Accionables_Pct",
              "fieldValue": "={{ $json.actionable_pct }}"
            }
          ]
        }
      },
      "id": "save-stats-survey-001",
      "name": "ğŸ“ˆ Save Statistics",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [2660, 500],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "google-sheets-oauth",
          "name": "Google Sheets OAuth2"
        }
      },
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000
    }
  ],
  "connections": {
    "â° Every 15 Minutes (9am-10pm)": {
      "main": [
        [
          {
            "node": "ğŸ“Š Read Survey Results from API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š Read Survey Results from API": {
      "main": [
        [
          {
            "node": "ğŸ” Filter Unprocessed Comments",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” Filter Unprocessed Comments": {
      "main": [
        [
          {
            "node": "ğŸ“¦ Split into Batches of 10",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¦ Split into Batches of 10": {
      "main": [
        [
          {
            "node": "ğŸ”„ Loop Over Comments",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”„ Loop Over Comments": {
      "main": [
        [
          {
            "node": "ğŸ¤– Analyze Sentiment with Gemini",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ“¦ Split into Batches of 10",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ¤– Analyze Sentiment with Gemini": {
      "main": [
        [
          {
            "node": "ğŸ§  Extract Sentiment Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ§  Extract Sentiment Analysis": {
      "main": [
        [
          {
            "node": "â±ï¸ Wait 1s (Rate Limit)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â±ï¸ Wait 1s (Rate Limit)": {
      "main": [
        [
          {
            "node": "ğŸ’¾ Update Survey with Sentiment",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’¾ Update Survey with Sentiment": {
      "main": [
        [
          {
            "node": "ğŸ“Š Save to Google Sheets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š Save to Google Sheets": {
      "main": [
        [
          {
            "node": "ğŸ˜Ÿ Is Negative or High Urgency?",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ“Š Calculate Statistics",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ˜Ÿ Is Negative or High Urgency?": {
      "main": [
        [
          {
            "node": "ğŸ“± Format Telegram Alert",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "ğŸ“± Format Telegram Alert": {
      "main": [
        [
          {
            "node": "ğŸ“¢ Send Telegram Alert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š Calculate Statistics": {
      "main": [
        [
          {
            "node": "ğŸ“ˆ Save Statistics",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveExecutionProgress": true,
    "saveDataSuccessExecution": "all",
    "saveDataErrorExecution": "all"
  },
  "staticData": null,
  "meta": {
    "instanceId": "capibobba-sentiment-survey-analysis",
    "version": "1.0.0",
    "description": "AnÃ¡lisis de sentimientos para comentarios de encuestas de CapiBobba usando Gemini AI"
  },
  "tags": [
    {
      "name": "analytics",
      "id": "analytics-002"
    },
    {
      "name": "ai",
      "id": "ai-002"
    },
    {
      "name": "surveys",
      "id": "surveys-001"
    }
  ],
  "active": false,
  "createdAt": "2025-10-11T00:00:00.000Z",
  "updatedAt": "2025-10-11T00:00:00.000Z"
}
